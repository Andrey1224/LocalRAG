PRD FILE

# üìò PRD: API /ask ‚Äî –ü–æ–∏—Å–∫ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç–≤–µ—Ç–∞

## tl;dr

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API-—ç–Ω–¥–ø–æ–∏–Ω—Ç `/ask`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (BM25 + dense), –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é cross-encoder, –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ LLM —Å —Ç–æ—á–Ω—ã–º–∏ —Ü–∏—Ç–∞—Ç–∞–º–∏. –í—Å—è —Ü–µ–ø–æ—á–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ (Docker), —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (trace_id).

---

## üéØ Goals

### –ë–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏

- –°–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã.
- –£–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–Ω–∞–Ω–∏—è–º –∏–∑ PDF, Markdown, HTML-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
- –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–∞–Ω–∏–∏.

### –¶–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- –ü–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–π, –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç.
- –í–∏–¥–µ—Ç—å, –æ—Ç–∫—É–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ü–∏—Ç–∞—Ç–∞, –∏—Å—Ç–æ—á–Ω–∏–∫, —Å–µ–∫—Ü–∏—è).
- –ü–æ–Ω–∏–º–∞—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ—Ä–µ–Ω–∞ –≤ –æ—Ç–≤–µ—Ç–µ.

### –ù–µ –≤—Ö–æ–¥–∏—Ç –≤ –∑–∞–¥–∞—á–∏

- –û—Ç–≤–µ—Ç—ã –±–µ–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
- –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- UI, fine-tuning –º–æ–¥–µ–ª–µ–π.

---

## üë§ User Stories

- –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —è —Ö–æ—á—É –≤–≤–µ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–∞–º–∏.
- –ö–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä, —è —Ö–æ—á—É –¥–æ–≤–µ—Ä—è—Ç—å –æ—Ç–≤–µ—Ç–∞–º, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–∏–∂—É –∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
- –ö–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, —è —Ö–æ—á—É –¥–µ–±–∞–∂–∏—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (—á–µ—Ä–µ–∑ trace_id).

---

## üîÅ User Flow

### POST /ask

**–ó–∞–ø—Ä–æ—Å**:
```json
{
  "question": "–ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ—Å—Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞?"
}

–û–±—Ä–∞–±–æ—Ç–∫–∞:

BM25-–ø–æ–∏—Å–∫ –ø–æ OpenSearch

Dense-–ø–æ–∏—Å–∫ –ø–æ Qdrant

–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

–ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∫–∞ cross-encoder‚Äô–æ–º

–û—Ç–±–æ—Ä –ª—É—á—à–∏—Ö 5 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å —Ü–∏—Ç–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ LLM

–í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å debug-–¥–∞–Ω–Ω—ã–º–∏

–û—Ç–≤–µ—Ç:

{
  "answer": "–ü—Ä–æ—Ü–µ—Å—Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∏ —ç—Ç–∞–ø–∞... [source: doc1, page 4]",
  "citations": [
    {
      "source": "doc1",
      "doc_title": "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç",
      "section": "–ü—Ä–æ—Ü–µ—Å—Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
      "page": 4
    }
  ],
  "debug": {
    "trace_id": "c3181d62-a5e6-4b45-9b10-d9acb4a7f8e3",
    "bm25_time_ms": 44,
    "dense_time_ms": 130,
    "rerank_time_ms": 90,
    "generation_time_ms": 2100,
    "confidence_score": 0.76
  }
}

üìñ Narrative
–Æ—Ä–∏—Å—Ç—É –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞. –û–Ω –≤–≤–æ–¥–∏—Ç –≤–æ–ø—Ä–æ—Å, –∏ —Å–∏—Å—Ç–µ–º–∞ –≤—ã–¥–∞—ë—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π –æ—Ç–≤–µ—Ç —Å —Ü–∏—Ç–∞—Ç–æ–π –∏–∑ –Ω—É–∂–Ω–æ–≥–æ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞. –û–Ω —Ç—Ä–∞—Ç–∏—Ç —Å–µ–∫—É–Ω–¥—ã, –∞ –Ω–µ —á–∞—Å—ã. –¢–∞–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ–Ω—è–µ—Ç –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏.

‚úÖ Success Metrics
–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∏–Ω–∏–º—É–º 1 —Ü–∏—Ç–∞—Ç—É.

–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ ‚â§ 7 —Å–µ–∫ (CPU-only).

RAGAS:

faithfulness ‚â• 0.65

answer_relevancy ‚â• 0.60

–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 8/10 —É—Å–ø–µ—à–Ω—ã—Ö –∫–µ–π—Å–æ–≤.

–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç:

–ò–Ω–¥–µ–∫—Å—ã, reranker, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
üß† Technical Details
LLM: Ollama (llama3.1:8b –∏–ª–∏ qwen2.5)

BM25: OpenSearch 2.x

Dense: Qdrant + BAAI/bge-small-en-v1.5

Reranker: BAAI/bge-reranker-v2-m3 via FlagEmbedding

FastAPI, Python 3.11+

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è: Docker Compose

Limits:

–û—Ç–≤–µ—Ç: ‚â§ 400 —Ç–æ–∫–µ–Ω–æ–≤

–ö–æ–Ω—Ç–µ–∫—Å—Ç: ‚â§ 2500 —Ç–æ–∫–µ–Ω–æ–≤

üìÜ Milestones
Week 1 ‚Äî –ò–Ω–¥–µ–∫—Å—ã, –±–∞–∑–æ–≤—ã–π API

Week 2 ‚Äî –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ + rerank

Week 3 ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM

Week 4 ‚Äî Debug + —Ç–µ—Å—Ç—ã

Week 5 ‚Äî Eval + —Ä—É—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

Week 6 ‚Äî Docker —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

üß± JSON-—Å—Ö–µ–º—ã
–ó–∞–ø—Ä–æ—Å: POST /ask
{
  "type": "object",
  "properties": {
    "question": { "type": "string", "minLength": 5 }
  },
  "required": ["question"]
}

–û—Ç–≤–µ—Ç: 200 OK
{
  "type": "object",
  "properties": {
    "answer": { "type": "string" },
    "citations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "source": { "type": "string" },
          "doc_title": { "type": "string" },
          "section": { "type": "string" },
          "page": { "type": "integer" }
        },
        "required": ["source", "doc_title"]
      }
    },
    "debug": {
      "type": "object",
      "properties": {
        "trace_id": { "type": "string" },
        "bm25_time_ms": { "type": "number" },
        "dense_time_ms": { "type": "number" },
        "rerank_time_ms": { "type": "number" },
        "generation_time_ms": { "type": "number" },
        "confidence_score": { "type": "number" }
      }
    }
  },
  "required": ["answer", "citations"]
}

–û—à–∏–±–∫–∞: 4xx/5xx
{
  "type": "object",
  "properties": {
    "error": { "type": "string" },
    "code": {
      "type": "string",
      "enum": [
        "MISSING_QUESTION",
        "INVALID_QUESTION",
        "NO_RESULTS",
        "RERANKER_FAILED",
        "LLM_FAILED",
        "TIMEOUT",
        "UNKNOWN_ERROR"
      ]
    }
  },
  "required": ["error", "code"]
}

üö® Edge-–∫–µ–π—Å—ã
–°—Ü–µ–Ω–∞—Ä–∏–π

–ö–æ–¥

–ö–æ–¥ –æ—à–∏–±–∫–∏

–ü–æ–≤–µ–¥–µ–Ω–∏–µ

–ù–µ—Ç question

400

MISSING_QUESTION

–í–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É

–í–æ–ø—Ä–æ—Å < 5 —Å–∏–º–≤–æ–ª–æ–≤

400

INVALID_QUESTION

–í–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É

–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

200

NO_RESULTS

–û—Ç–≤–µ—Ç: ‚Äú–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö‚Äù

Reranker —É–ø–∞–ª

500

RERANKER_FAILED

–û—Ç–≤–µ—Ç —Å trace_id

LLM —É–ø–∞–ª

500

LLM_FAILED

–û—Ç–≤–µ—Ç —Å trace_id

–¢–∞–π–º–∞—É—Ç > 10 —Å–µ–∫

504

TIMEOUT

–û—Ç–≤–µ—Ç —Å trace_id

–û—Ç–≤–µ—Ç > 400 —Ç–æ–∫–µ–Ω–æ–≤

200

‚Äî

–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å max_tokens

üß† System Prompt (LLM)
–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –¢—ã –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å –Ω–∏—á–µ–≥–æ —Å–∞–º. –í –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ —Ç—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—Å—Ç–∞–≤–ª—è–µ—à—å —Ü–∏—Ç–∞—Ç—ã, —É–∫–∞–∑—ã–≤–∞—è –∏—Å—Ç–æ—á–Ω–∏–∫ (source), –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (doc_title), —Å–µ–∫—Ü–∏—é –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (section/page).

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Ç—ã —á–µ—Å—Ç–Ω–æ –æ—Ç–≤–µ—á–∞–µ—à—å: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞."

–§–æ—Ä–º–∞—Ç —Ü–∏—Ç–∞—Ç: [source: doc1, page 4]

–ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —è—Å–Ω–æ –∏ —Ç–æ—á–Ω–æ.

