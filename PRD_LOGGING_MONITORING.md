

---

````markdown
# üìä PRD: –õ–æ–≥–≥–∏–Ω–≥ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤

## tl;dr

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥–≥–∏–Ω–≥ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ API: `/ask`, `/feedback`, `/eval/run`. –õ–æ–≥–∏ –≤–∫–ª—é—á–∞—é—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞, —Ç–∞–π–º–∏–Ω–≥–∏, trace_id, —Å—Ç–∞—Ç—É—Å—ã –∏ –æ—à–∏–±–∫–∏. –í dev-—Ä–µ–∂–∏–º–µ –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ stdout –∏ –ª–æ–≥-—Ñ–∞–π–ª–µ. –í prod ‚Äî –≤–µ–¥—ë—Ç—Å—è —Ñ–∞–π–ª —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (Sentry, Logtail, Prometheus).

---

## üéØ Goals

### –ë–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏

- –ò–º–µ—Ç—å –ø–æ–ª–Ω—É—é —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫.
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –ø—Ä–æ–¥–∞–∫—à–Ω-–Ω–∞–≥—Ä—É–∑–∫–∞–º.

### –¶–µ–ª–∏ –∫–æ–º–∞–Ω–¥—ã

- –í–∏–¥–µ—Ç—å latency –ø–æ –∫–∞–∂–¥–æ–º—É —ç—Ç–∞–ø—É –ø–∞–π–ø–ª–∞–π–Ω–∞ `/ask`.
- –õ–æ–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ trace_id.
- –°—á–∏—Ç–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤, –æ—Ç–∑—ã–≤–æ–≤, –æ—à–∏–±–æ–∫.

---

## üß† –ß—Ç–æ –ª–æ–≥–≥–∏—Ä—É–µ—Ç—Å—è

### –û–±—â–∏–µ –ø–æ–ª—è (–≤–µ–∑–¥–µ):

- `timestamp`
- `trace_id` (UUIDv4)
- `session_id`, `user_id` (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `IP`, `user_agent`

### –î–ª—è /ask:

- `question`
- `llm_model`, `reranker`
- `latency_total`
- –ü–æ–¥—ç—Ç–∞–ø—ã:
  - `bm25_time_ms`
  - `embedding_time_ms`
  - `rerank_time_ms`
  - `llm_response_time_ms`
- `status_code`

### –î–ª—è /feedback:

- `request_id`
- `rating`, `reason`, `comment` (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –î–ª—è /eval/run:

- `eval_type`
- `num_cases`
- `total_eval_time_ms`
- `avg_case_time_ms`
- –û—à–∏–±–∫–∏ –ø–æ –∫–µ–π—Å–∞–º (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –ò—Å–∫–ª—é—á–µ–Ω–∏—è:

- stacktrace
- —É—Ä–æ–≤–µ–Ω—å ‚Äî ERROR
- trace_id

---

## ‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- –ò—Å–ø–æ–ª—å–∑—É–µ–º Python `logging` –º–æ–¥—É–ª—å.
- Middleware –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
- –§–æ—Ä–º–∞—Ç: JSON-–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

### –†–µ–∂–∏–º—ã:

| –†–µ–∂–∏–º | –ü–æ—Ç–æ–∫ –ª–æ–≥–æ–≤ | –§–∞–π–ª | –î–µ—Ç–∞–ª–∏ |
|-------|-------------|------|--------|
| dev   | stdout + —Ñ–∞–π–ª | `logs/dev.log` | –í–∫–ª—é—á–∞–µ—Ç —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞ |
| prod  | —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª | `logs/app.log` (—Ä–æ—Ç–∞—Ü–∏—è) | –ë–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ |

### –†–æ—Ç–∞—Ü–∏—è:

- –ß–µ—Ä–µ–∑ `TimedRotatingFileHandler`
- –õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è 7 –¥–Ω–µ–π
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: max 10MB

---

## üßæ –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ (dev)

```json
{
  "timestamp": "2025-08-16T12:00:00Z",
  "trace_id": "9df6a1f3...",
  "endpoint": "/ask",
  "question": "–ö–∞–∫–∏–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –ø–æ–ª–∏—Ç–∏–∫–µ?",
  "llm_model": "llama3.1:8b",
  "latency_total_ms": 2840,
  "bm25_time_ms": 44,
  "embedding_time_ms": 130,
  "rerank_time_ms": 90,
  "llm_response_time_ms": 2000,
  "status_code": 200,
  "session_id": "sess_123",
  "user_agent": "Mozilla/5.0"
}
````

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ (–≤ –±—É–¥—É—â–µ–º —á–µ—Ä–µ–∑ Prometheus)

* `total_requests_per_day`
* `avg_latency_per_endpoint`
* `errors_by_type`
* `feedback_positive_ratio`
* `top_negative_reasons`

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã —Ü–µ–ª–∏–∫–æ–º –≤ –ø—Ä–æ–¥–µ.
* –ú–∞—Å–∫–∏—Ä—É–µ–º:

  * IP (–Ω–∞–ø—Ä–∏–º–µ—Ä, `***.***.1.12`)
  * –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`tokens`, `emails`, `names`)
* –í –±—É–¥—É—â–µ–º: scrubber –¥–ª—è GDPR / PII

---

## üîÅ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–±—É–¥—É—â–µ–µ)

| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ             |
| ---------- | ---------------------- |
| Sentry     | –û—à–∏–±–∫–∏ –∏ —Ç—Ä–µ–π—Å–∏–Ω–≥      |
| Logtail    | –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ |
| Prometheus | –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã       |
| Grafana    | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤  |

---

## üìÜ Milestones

1. **Week 1** ‚Äî –ë–∞–∑–æ–≤—ã–π –ª–æ–≥–≥–∏–Ω–≥ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, trace\_id, latency
2. **Week 2** ‚Äî –ò—Å–∫–ª—é—á–µ–Ω–∏—è, —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤, dev/prod —Ä–µ–∂–∏–º—ã
3. **Week 3** ‚Äî –ü—Ä–æ—Ç–æ—Ç–∏–ø –º–µ—Ç—Ä–∏–∫, –∞–≥—Ä–µ–≥–∞—Ç—ã
4. **Week 4** ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º –ª–æ–≥–≥–µ—Ä–æ–º (Sentry/Logtail)

---


